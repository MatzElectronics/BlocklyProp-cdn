var cursorX=0,cursorY=0,cursorGotoX=0,cursorGotoY=0,termSetCursor=0,textContainer=[""],term_been_scrolled=!1,fontSize="14px",termPxWide="560px",termPxHigh="380px",lineHeight=Math.floor(1.1*parseInt(fontSize.replace("px",""))),term_width=Math.floor(parseInt(fontSize.replace("px","")))/1.65,term_height=Math.floor(parseInt(termPxHigh.replace("px","")));term_width=Math.floor((parseInt(termPxWide.replace("px",""))-25)/term_width);
var ascii2unicode="\u00c7\u00fc\u00e9\u00e2\u00e4\u00e0\u00e5\u00e7\u00ea\u00eb\u00e8\u00ef\u00ee\u00ec\u00c4\u00c5\u00c9\u00e6\u00c6\u00f4\u00f6\u00f2\u00fb\u00f9\u00ff\u00d6\u00dc\u00a2\u00a3\u00a5\u20a7\u0192\u00e1\u00ed\u00f3\u00fa\u00f1\u00d1\u00aa\u00ba\u00bf\u2310\u00ac\u00bd\u00bc\u00a1\u00ab\u00bb\u2591\u2592\u2593\u2502\u2524\u2561\u2562\u2556\u2555\u2563\u2551\u2557\u255d\u255c\u255b\u2510\u2514\u2534\u252c\u251c\u2500\u253c\u255e\u255f\u255a\u2554\u2569\u2566\u2560\u2550\u256c\u2567\u2568\u2564\u2565\u2559\u2558\u2552\u2553\u256b\u256a\u2518\u250c\u2588\u2584\u258c\u2590\u2580\u03b1\u00df\u0393\u03c0\u03a3\u03c3\u00b5\u03c4\u03a6\u0398\u03a9\u03b4\u221e\u03c6\u03b5\u2229\u2261\u00b1\u2265\u2264\u2320\u2321\u00f7\u2248\u00b0\u2219\u00b7\u221a\u207f\u00b2\u25a0\u00a0".split(""),echo_trap=
[],trap_echos=!1,echo_keys=!0,terminal_buffer="",updateTermInterval=null,bufferAlert=!1,scrollerTimeout=null;
$(document).ready(function(){fontSize=$("#serial_console").css("font-size");termPxWide=$("#serial_console").css("width");termPxHigh=$("#serial_console").css("height");lineHeight=Math.floor(1.1*parseInt(fontSize.replace("px","")));term_width=256;$("#serial_console").css({"overflow-x":"scroll"});term_height=Math.floor(parseInt(termPxHigh.replace("px","")));$("#serial_console").keydown(function(a){a=a.keyCode||a.which;8!==a&&13!==a||processKey(a);return 47<a&&58>a||32===a||64<a&&91>a||95<a&&112>a||185<
a&&193>a||218<a&&223>a});$("#serial_console").keypress(function(a){processKey(a.charCode)});$("#serial_console").click(function(){var a=document.getElementById("serial_console").innerHTML;"\u258d"!==a[a.length-1]&&(document.getElementById("serial_console").innerHTML=a+"\u258d")});$("#serial_console").blur(function(){var a=document.getElementById("serial_console").innerHTML;"\u258d"===a[a.length-1]&&(document.getElementById("serial_console").innerHTML=a.slice(0,-1),"\u258d"===a&&(document.getElementById("serial_console").innerHTML=
""))})});
function processKey(a){var b=String.fromCharCode(a);null!==active_connection&&"simulated"!==active_connection&&"websocket"!==active_connection?client_version>=minEnc64Ver?(active_connection.send(btoa(b)),echo_keys&&displayInTerm(b)):(active_connection.send(b),trap_echos&&echo_trap.push(a)):"simulated"===active_connection?displayInTerm(b):"websocket"===active_connection&&(a={type:"serial-terminal",outTo:"terminal",portPath:getComPort(),baudrate:baudrate.toString(10),msg:b,action:"msg"},client_ws_connection.send(JSON.stringify(a)),echo_keys&&
displayInTerm(b))}function displayInTerm(a){var b=terminal_buffer.length;terminal_buffer+=a;0===b?sendBufferToTerm():255<b&&!1===bufferAlert&&termBufferWarning()}function termBufferWarning(){bufferAlert=!0;var a=document.getElementById("serial-conn-info"),b=a.innerHTML;a.innerHTML='<span class="alert-danger">Your program is sending too much data to the terminal at once.<br>Try adding pauses or sending less data.</span>';setTimeout(function(){a.innerHTML=b;bufferAlert=!1},5E3)}
function sendBufferToTerm(){do updateTermBox(terminal_buffer.charCodeAt(0)),terminal_buffer=terminal_buffer.substr(1);while(0<terminal_buffer.length);displayTerm()}
function updateTermBox(a){for(zz=0;zz<echo_trap.length;zz++)if(echo_trap[zz]===a){echo_trap.splice(zz,1);return}cursorGotoY=cursorY;4!==termSetCursor&&(cursorGotoX=cursorX);a=parseInt(a);switch(termSetCursor){case 3:cursorGotoX=parseInt(a);termSetCursor=4;break;case 2:case 4:cursorGotoY=parseInt(a);termSetCursor=0;setCursor(cursorGotoX,cursorGotoY);break;case 1:cursorGotoX=parseInt(a);termSetCursor=0;setCursor(cursorGotoX,cursorGotoY);break;case 0:switch(a){case 127:case 8:if(-1<cursorX+cursorY){if(1<
textContainer[cursorY].length)if(cursorX===textContainer[cursorY].length)textContainer[cursorY]=textContainer[cursorY].slice(0,-1);else{if(0<cursorX){var b=textContainer[cursorY];textContainer[cursorY]=b.substr(0,cursorX-1)+" "+b.substr(cursorX)}}else 1===textContainer[cursorY].length&&(textContainer[cursorY]=textContainer[cursorY]="");changeCursor(-1,0);break}case 13:case 10:term_been_scrolled=!0;changeCursor(0,1);break;case 9:b=5-cursorX%5;for(k=0;k<b;k++)textContainer[cursorY]+=" ",changeCursor(1,
0);break;case 0:case 16:textContainer=null,textContainer=[""];case 1:cursorY=cursorX=0;changeCursor(0,0);break;case 3:changeCursor(-1,0);break;case 4:changeCursor(1,0);break;case 5:changeCursor(0,-1);break;case 6:changeCursor(0,1);break;case 7:document.getElementById("serial_console").classList.remove("visual-beep");document.getElementById("serial_console");document.getElementById("serial_console").classList.add("visual-beep");document.getElementById("term-beep").play();break;case 11:textContainer[cursorY]=
textContainer[cursorY].substr(0,cursorX);break;case 12:for(b=cursorY+1;b<textContainer.length;b++)textContainer[b].pop();break;case 2:termSetCursor=3;break;case 14:case 15:termSetCursor=a-13;break;default:var c=127<a&&256>a?ascii2unicode[a-128]:String.fromCharCode(a);(textContainer[cursorY]||"").length>cursorX?(b=textContainer[cursorY]||"",textContainer[cursorY]=b.substr(0,cursorX)+c+b.substr(cursorX+1)):textContainer[cursorY]+=c;changeCursor(1,0)}}0===a&&displayTerm()}
function changeCursor(a,b){1===b&&textContainer[cursorY].length>=cursorX&&(textContainer[cursorY]=textContainer[cursorY].substr(0,cursorX));cursorX+=a;cursorY+=b;cursorX>term_width-1&&(cursorX-=term_width,cursorY++,textContainer[cursorY]||(textContainer[cursorY]=""));0>cursorX&&(cursorY--,cursorX=textContainer[cursorY].length,cursorX>term_width-1&&(cursorX=term_width-1,textContainer[cursorY]=textContainer[cursorY].substr(0,cursorX)));0>cursorY&&(cursorX=cursorY=0);1===b&&(cursorX=0,textContainer[cursorY]||
(textContainer[cursorY]=""))}
function displayTerm(){updateTermInterval=null;cursorY<textContainer.length-1&&""===textContainer[textContainer.length-1]&&textContainer.pop();var a=Math.floor(term_height/lineHeight),b="";document.getElementById("serial_console")===document.activeElement&&(b="\u258d");var c=textContainer.join("\r")+b;""===textContainer.join("")&&(c=b);cursorY>=a&&term_been_scrolled&&($("#serial_console").css("overflow-y","hidden"),$("#serial_console").scrollTop((cursorY-a+1)*lineHeight),$("#serial_console").css("overflow-y",
"scroll"),term_been_scrolled=!1);document.getElementById("serial_console").innerHTML=c.replace(/ /g,"&nbsp;").replace(/\r/g,"<br>")}function setCursor(a,b){a>term_width-1&&(a%=term_width);if(!textContainer[b])for(t=textContainer.length;t<=b;t++)textContainer[t]="";for(;!textContainer[b][a];)textContainer[b]+=" ";cursorX=a;cursorY=b;changeCursor(0,0)};
