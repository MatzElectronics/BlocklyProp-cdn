var baseUrl=$("meta[name=base]").attr("content"),cdnUrl=$("meta[name=cdn]").attr("content"),user_authenticated="true"===$("meta[name=user-auth]").attr("content")?!0:!1,isOffline="true"===$("meta[name=isOffline]").attr("content")?!0:!1,projectData=null,ignoreSaveCheck=!1,last_saved_timestamp=0,last_saved_time=0,idProject=0,uploadedXML="";
$(document).ready(function(){user_authenticated?($(".auth-true").css("display",$(this).attr("data-displayas")),$(".auth-false").css("display","none")):($(".auth-false").css("display",$(this).attr("data-displayas")),$(".auth-true").css("display","none"));$(".url-prefix").attr("href",function(a,b){return baseUrl+b});for(var a=document.getElementsByTagName("img"),b=0;b<a.length;b++)a[b].src=cdnUrl+a[b].getAttribute("data-src");getURLParameter("debug")||isOffline?document.getElementById("btn-view-xml").style.display=
"inline-block":document.getElementById("btn-view-xml").style.display="none";$(".client-win32-link").attr("href",$("meta[name=win32client]").attr("content"));$(".client-win64-link").attr("href",$("meta[name=win64client]").attr("content"));$(".client-mac-link").attr("href",$("meta[name=macOSclient]").attr("content"));idProject=getURLParameter("project");a=null;if(-1<window.location.href.indexOf("projectlink"))a=atob($("meta[name=projectlink]").attr("content")),a=JSON.parse(a),setupWorkspace(a);else if(idProject||
isOffline)if(!idProject&&isOffline){isOffline=!0;clearInterval(pingInterval);$(".online-only").addClass("hidden");$(".offline-only").removeClass("hidden");$("#save_as_dialog_title_text").html("Choose a project name and board type");$("#save_as_dialog_button").html("Continue");$(".save-as-close").addClass("hidden");$("#save-as-project-name").val("MyProject");$("#saveAsDialogSender").html("offline");$("#save-as-board-type").empty();for(key in profile)$("#save-as-board-type").append($("<option />").val(key).text(profile[key].description));
"true"===getURLParameter("openFile")&&isOffline?$("#upload-dialog").modal("show"):window.localStorage.getItem("localProject")?setupWorkspace(JSON.parse(window.localStorage.getItem("localProject"))):$("#save-as-type-dialog").modal("show")}else $.get(baseUrl+"rest/shared/project/editor/"+idProject,function(a){setupWorkspace(a)}).fail(function(){utils.showMessage("Unable to Access Project","The BlocklyProp Editor was unable to access the project you requested.  If you are sure the project exists, you may need to contact the project's owner and ask them to share their project before you will be able to view it.",
function(){window.location=baseUrl})});else window.location=baseUrl;$("#save-project").on("click",function(){isOffline?downloadCode():saveProject()});$("#save-project-as").on("click",function(){saveAsDialog()});$("#download-project").on("click",function(){downloadCode()});$("#upload-project").on("click",function(){uploadCode()});$("#save-check-dialog").on("hidden.bs.modal",function(){timestampSaveTime(5,!1)})});
var setupWorkspace=function(a){console.log(a);projectData=a;showInfo(a);idProject||(idProject=projectData.id);setProfile(projectData.board);"propcfile"!==projectData.board?initToolbox(projectData.board,[]):(init(Blockly),renderContent("propc"));"s3"===projectData.board?($("#prop-btn-ram").addClass("hidden"),$("#prop-btn-graph").addClass("hidden"),document.getElementById("client-available").innerHTML=document.getElementById("client-available-short").innerHTML):($("#prop-btn-ram").removeClass("hidden"),
$("#prop-btn-graph").removeClass("hidden"),document.getElementById("client-available").innerHTML=document.getElementById("client-available-long").innerHTML);projectData&&!1===projectData.yours?$("#edit-project-details").html(page_text_label["editor_view-details"]):$("#edit-project-details").html(page_text_label["editor_edit-details"]);timestampSaveTime(20,!0);setInterval(checkLastSavedTime,6E4)},timestampSaveTime=function(a,b){var c=new Date;c.getTime()+6E4*a>last_saved_timestamp&&(last_saved_timestamp=
c.getTime()+6E4*a,b&&(last_saved_time=c.getTime()))},checkLastSavedTime=function(){var a=new Date,b=a.getTime();a=Math.round((a.getTime()-last_saved_time)/6E4);$("#save-check-warning-time").html(a.toString(10));b>last_saved_timestamp&&checkLeave()&&user_authenticated&&$("#save-check-dialog").modal("show")},showInfo=function(a){$(".project-name").text(a.name);a.yours||$(".project-owner").text("("+a.user+")");$("#project-icon").html('<img src="'+cdnUrl+{"activity-board":"images/board-icons/IconActivityBoard.png",
s3:"images/board-icons/IconS3.png",heb:"images/board-icons/IconBadge.png","heb-wx":"images/board-icons/IconBadgeWX.png",flip:"images/board-icons/IconFlip.png",other:"images/board-icons/IconOtherBoards.png",propcfile:"images/board-icons/IconC.png"}[a.board]+'"/>')},saveProject=function(){if(projectData.yours){var a="";a="propcfile"===projectData.board?propcAsBlocksXml():getXml();projectData.code=a;$.post(baseUrl+"rest/project/code",projectData,function(b){var c=projectData.yours;projectData=b;projectData.code=
a;c||(window.location.href=baseUrl+"projecteditor?id="+b.id)}).done(function(){var a=document.getElementById("save-project");a.style.paddingLeft="10px";a.style.background="rgb(92, 184, 92)";a.style.borderColor="rgb(76, 174, 76)";setTimeout(function(){a.innerHTML="Save &#x2713;"},600);setTimeout(function(){a.innerHTML="Save&nbsp;&nbsp;";a.style.paddingLeft="15px";a.style.background="#337ab7";a.style.borderColor="#2e6da4"},1750)}).fail(function(){var a=document.getElementById("save-project");a.style.paddingLeft=
"10px";a.style.background="rgb(214, 44, 44)";a.style.borderColor="rgb(191, 38, 38)";setTimeout(function(){a.innerHTML="Save &times;"},600);setTimeout(function(){a.innerHTML="Save&nbsp;&nbsp;";a.style.paddingLeft="15px";a.style.background="#337ab7";a.style.borderColor="#2e6da4"},1750);utils.showMessage("Not logged in","BlocklyProp was unable to save your project.\n\nYou may still be able to download it as a Blockls file.\n\nYou will need to return to the homepage to log back in.")});timestampSaveTime(20,
!0)}else saveAsDialog()},saveAsDialog=function(){"demo"!==inDemo?utils.prompt("Save project as",projectData.name,function(a){if(a){var b=getXml();projectData.code=b;projectData.name=a;$.post(baseUrl+"rest/project/code-as",projectData,function(a){projectData=a;projectData.code=b;utils.showMessage(Blockly.Msg.DIALOG_PROJECT_SAVED,Blockly.Msg.DIALOG_PROJECT_SAVED_TEXT);window.location.href=baseUrl+"projecteditor?id="+a.id})}}):(checkLeave()&&projectData.yours&&utils.confirm(Blockly.Msg.DIALOG_SAVE_TITLE,
Blockly.Msg.DIALOG_SAVE_FIRST,function(a){a&&(isOffline?downloadCode():saveProject())},"Yes","No"),$("#save-as-project-name").val(projectData.name),$("#save-as-board-type").empty(),profile.default.saves_to.forEach(function(a){$("#save-as-board-type").append($("<option />").val(a[1]).text(a[0]))}),"demo"===inDemo&&$("#save-as-board-type").append($("<option />").val("propcfile").text("Propeller C (code-only)")),$("#save-as-type-dialog").modal("show"))},checkBoardType=function(a){if("offline"!==a){a=
projectData.board;var b=$("#save-as-board-type").val();a===b||"propcfile"===b?document.getElementById("save-as-verify-boardtype").style.display="none":document.getElementById("save-as-verify-boardtype").style.display="block"}},saveProjectAs=function(a){var b=$("#save-as-board-type").val(),c=$("#save-as-project-name").val(),e="";"offline"!==a?(e=projectData&&"propcfile"===b?propcAsBlocksXml():getXml(),projectData.board=b,projectData.code=e,projectData.name=c,$.post(baseUrl+"rest/project/code-as",projectData,
function(a){projectData=a;projectData.code=e;window.location.href=baseUrl+"projecteditor?id="+a.id}),timestampSaveTime(20,!0)):(a=new Date,setupWorkspace({board:b,code:'<xml xmlns="http://www.w3.org/1999/xhtml"></xml>',created:a,description:"","description-html":"",id:0,modified:a,name:c,"private":!0,shared:!1,type:"PROPC",user:"offline",yours:!0}))},editProjectDetails=function(){isOffline?(projectData.modified=new Date,projectData.code=getXml(),window.localStorage.setItem("localProject",JSON.stringify(projectData)),
window.location="projectcreate.html?edit=true"):window.location.href=baseUrl+"my/projects.jsp#"+idProject};window.onbeforeunload=function(){if(checkLeave()&&!isOffline)return Blockly.Msg.DIALOG_CHANGED_SINCE};
var checkLeave=function(){var a=projectData.code;if(ignoreSaveCheck)return!1;var b="propcfile"===projectData.board?propcAsBlocksXml():getXml();return null===projectData?'<xml xmlns="http://www.w3.org/1999/xhtml"></xml>'===b?!1:!0:a===b?!1:!0},pingInterval=setInterval(function(){$.get(baseUrl+"ping")},6E4);function hashCode(a){for(var b=0,c=0,e=a.length;c<e;)b=(b<<5)-b+a.charCodeAt(c++)<<0;return b+2147483647+1}
function downloadCode(){var a="";a=projectData&&"propcfile"===projectData.board?propcAsBlocksXml():getXml();a=a.substring(42,a.length);a=a.substring(0,a.length-6);var b="Project"+idProject;isOffline&&(b=projectData.name.replace(/[^a-z0-9]/gi,"_").toLowerCase());utils.prompt(Blockly.Msg.DIALOG_DOWNLOAD,b,function(b){if(b){var c=document.getElementsByClassName("blocklyBlockCanvas"),g=c[0].outerHTML.replace(/&nbsp;/g," ");c=c[0].getBoundingClientRect();var d=(parseInt(c.height)+parseInt(c.top)+100).toString(),
f=(parseInt(c.width)+parseInt(c.left)+236).toString();c=function(){var a=document.createElement("a");document.body.appendChild(a);a.style="display: none";return function(b,c){b=new Blob([b],{type:"octet/stream"});b=window.URL.createObjectURL(b);a.href=b;a.download=c;a.click();window.URL.revokeObjectURL(b)}}();d='<svg blocklyprop="blocklypropproject" xmlns="http://www.w3.org/2000/svg" xmlns:html="http://www.w3.org/1999/xhtml" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="blocklySvg"><style>.blocklySvg { background-color: #fff; '+
("overflow: auto; width:"+f+"px; height:"+d+"px;} .blocklyWidgetDiv {display: none; position: absolute; ")+"z-index: 999;} .blocklyPathLight { fill: none; stroke-linecap: round; stroke-width: 2;} .blocklyDisabled>.blocklyPath { fill-opacity: .5; ";d+="stroke-opacity: .5;} .blocklyDisabled>.blocklyPathLight, .blocklyDisabled>";d+=".blocklyPathDark {display: none;} .blocklyText {cursor: default; fill: ";d+="#fff; font-family: sans-serif; font-size: 11pt;} .blocklyNonEditableText>text { ";d+="pointer-events: none;} .blocklyNonEditableText>rect, .blocklyEditableText>rect ";
d+="{fill: #fff; fill-opacity: .6;} .blocklyNonEditableText>text, .blocklyEditableText>";d+="text {fill: #000;} .blocklyBubbleText {fill: #000;} .blocklySvg text {user";d+="-select: none; -moz-user-select: none; -webkit-user-select: none; cursor: ";d+="inherit;} .blocklyHidden {display: none;} .blocklyFieldDropdown:not(.blocklyHidden) ";d+="{display: block;} .bkginfo {cursor: default; fill: rgba(0, 0, 0, 0.3); font-family: ";d+="sans-serif; font-size: 10pt;}</style>";f='<rect x="100%" y="100%" rx="7" ry="7" width="218" height="84" style="fill:rgba(255,255,255,0.4);" transform="translate(-232,-100)" /><text class="bkginfo" x="100%" y="100%" transform="translate(-225,-83)" style="font-weight:bold;">Parallax BlocklyProp Project</text>'+
('<text class="bkginfo" x="100%" y="100%" transform="translate(-225,-68)">User: '+projectData.user+"</text>");f+='<text class="bkginfo" x="100%" y="100%" transform="translate(-225,-53)">Title: '+projectData.name+"</text>";f+='<text class="bkginfo" x="100%" y="100%" transform="translate(-225,-38)">Project ID: '+idProject+"</text>";f+='<text class="bkginfo" x="100%" y="100%" transform="translate(-225,-23)">Device: '+projectData.board+"</text>";-1!==b.indexOf(".")&&(b=b.substring(0,b.indexOf(".")));
30<=b.length&&(b=b.substring(0,29));b=b.replace(/[\\/:*?"<>|]/g,"_");var h=hashCode(a).toString();h="000000000000".substring(h.length,12)+h;c(d+g+f+a+"<ckm>"+h+"</ckm></svg>",b+".svg")}})}function uploadCode(){checkLeave()&&!isOffline?utils.showMessage(Blockly.Msg.DIALOG_UNSAVED_PROJECT,Blockly.Msg.DIALOG_SAVE_BEFORE_ADD_BLOCKS):$("#upload-dialog").modal("show")}
function uploadHandler(a){var b=new FileReader;b.onload=function(){var b=this.result,e=!1;if("image/svg+xml"===a[0].type&&0===b.indexOf('<svg blocklyprop="blocklypropproject"')&&-1===b.indexOf("<!ENTITY")&&-1===b.indexOf("CDATA")&&-1===b.indexOf("\x3c!--")){var g=b.substring(b.length-24,b.length-12);uploadedXML=b.substring(b.indexOf("<block"),b.length-29);var d=hashCode(uploadedXML).toString();d="000000000000".substring(d.length,12)+d;var f=b.indexOf('transform="translate(-225,-23)">Device: ');f=
b.substring(f+40,b.indexOf("</text>",f+41));d===g&&(e=!0);e&&(projectData&&f!==projectData.board?document.getElementById("selectfile-verify-boardtype").style.display="block":document.getElementById("selectfile-verify-boardtype").style.display="none");""!==uploadedXML&&(uploadedXML='<xml xmlns="http://www.w3.org/1999/xhtml">'+uploadedXML+"</xml>");"true"===getURLParameter("openFile")&&isOffline&&(g=b.indexOf('transform="translate(-225,-53)">Title: '),g=b.substring(g+39,b.indexOf("</text>",g+40)),d=
new Date,pd={board:f,code:uploadedXML,created:d,description:"","description-html":"",id:0,modified:d,name:g,"private":!0,shared:!1,type:"PROPC",user:"offline",yours:!0},window.localStorage.setItem("localProject",JSON.stringify(pd)),window.location="blocklyc.html")}!0===e?(document.getElementById("selectfile-verify-valid").style.display="block",document.getElementById("selectfile-replace").disabled=!1,document.getElementById("selectfile-append").disabled=!1,uploadedXML=b):(document.getElementById("selectfile-verify-notvalid").style.display=
"block",document.getElementById("selectfile-replace").disabled=!0,document.getElementById("selectfile-append").disabled=!0,uploadedXML="")};b.readAsText(a[0])}function clearUploadInfo(){uploadedXML="";$("#selectfile").val("");document.getElementById("selectfile-verify-notvalid").style.display="none";document.getElementById("selectfile-verify-valid").style.display="none";document.getElementById("selectfile-verify-boardtype").style.display="none"}
function uploadMergeCode(a){$("#upload-dialog").modal("hide");if(""!==uploadedXML){var b="";a&&(b=getXml(),b=b.substring(42,b.length),b=b.substring(0,b.length-6));a=uploadedXML;a=a.substring(42,a.length);a=a.substring(0,a.length-6);projectData.code='<xml xmlns="http://www.w3.org/1999/xhtml">'+b+a+"</xml>";Blockly.mainWorkspace.clear();loadToolbox(projectData.code);clearUploadInfo()}}
function initToolbox(a){var b=getURLParameter("font");if(b){for(var c=0;c<Blockly.Css.CONTENT.length;c++)Blockly.Css.CONTENT[c]=Blockly.Css.CONTENT[c].replace(/Arial, /g,"").replace(/sans-serif;/g,"'"+b+"', sans-serif;");$("html, body").css("font-family","'"+b+"', sans-serif");$(".blocklyWidgetDiv .goog-menuitem-content").css("font","'normal 14px '"+b+"', sans-serif !important'")}else for(c=0;c<Blockly.Css.CONTENT.length;c++)Blockly.Css.CONTENT[c]=Blockly.Css.CONTENT[c].replace(/Arial, /g,"").replace(/sans-serif;/g,
"Arimo, sans-serif;");Blockly.inject("content_blocks",{toolbox:filterToolbox(a),trashcan:!0,media:cdnUrl+"blockly/media/",readOnly:"propcfile"===a?!0:!1,comments:!1,zoom:{controls:!0,wheel:!1,startScale:1,maxScale:3,minScale:.3,scaleSpeed:1.2},grid:{spacing:20,length:5,colour:"#fbfbfb",snap:!1}});init(Blockly);Blockly.mainWorkspace.createVariable(Blockly.LANG_VARIABLES_GET_ITEM)}function loadToolbox(a){a=Blockly.Xml.textToDom(a);Blockly.Xml.domToWorkspace(a,Blockly.mainWorkspace)}
function getXml(){var a=Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);return Blockly.Xml.domToText(a)}function showOS(a){$("body").removeClass("Windows").removeClass("MacOS").removeClass("Linux").removeClass("ChromeOS");$("body").addClass(a)}
function showStep(a,b,c){for(var e=1;e<=c;e++)$("#"+a+e.toString()+"-btn").addClass("btn-default").removeClass("btn-primary"),$("#"+a+e.toString()).addClass("hidden");$("#"+a+b.toString()+"-btn").removeClass("btn-default").addClass("btn-primary");$("#"+a+b.toString()).removeClass("hidden")};
