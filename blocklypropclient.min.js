var client_available=!1,ports_available=!1,client_url="http://localhost:6009/",client_version=0,client_domain_name="localhost",client_domain_port=6009,client_min_version="0.6.0",client_recommended_version="0.7.0",client_use_type="none",client_ws_connection=null,client_ws_heartbeat,client_ws_heartbeat_interval=null,check_com_ports_interval=null,check_ws_socket_timeout=null,launcher_result="",launcher_download=!1,nsDownloading=2,nsDownloadSuccessful=5,neDownloadFailed=102;$(document).ready(function(){find_client()});
var find_client=function(){check_ws_socket_timeout&&clearTimeout(check_ws_socket_timeout);establish_socket();"ws"!==client_use_type&&check_client()},version_as_number=function(b){b=b.toString().split(".");b.push("0");3>b.length&&($("#client-unknown-span").removeClass("hidden"),$(".client-required-version").html(client_recommended_version),$(".client-your-version").html("<b>UNKNOWN</b>"),$("#client-version-modal").modal("show"),1===b.length?b="0.0.0":b.unshift("0"));return Number(b[0])<<20|Number(b[1])<<
10|Number(b[2])},set_ui_buttons=function(b){"available"===b?($("#client-available").removeClass("hidden"),$("#client-searching").addClass("hidden"),$("#client-unavailable").addClass("hidden"),$("#prop-btn-ram").removeClass("disabled"),$("#prop-btn-eeprom").removeClass("disabled"),$("#prop-btn-term").removeClass("disabled"),$("#prop-btn-graph").removeClass("disabled")):($("#prop-btn-ram").addClass("disabled"),$("#prop-btn-eeprom").addClass("disabled"),$("#prop-btn-term").addClass("disabled"),$("#prop-btn-graph").addClass("disabled"),
"searching"===b?($("#client-available").addClass("hidden"),$("#client-searching").removeClass("hidden"),$("#client-unavailable").addClass("hidden")):($("#client-available").addClass("hidden"),$("#client-searching").addClass("hidden"),$("#client-unavailable").removeClass("hidden")))},check_client=function(){"ws"!==client_use_type&&$.get(client_url,function(b){client_available||(client_version=version_as_number("undefined"!==typeof b.version_str?b.version_str:b.version),b.server&&"BlocklyPropHTTP"===
b.server?client_version<version_as_number(client_min_version)?($(".bpc-version").addClass("hidden"),$("#client-danger-span").removeClass("hidden"),$(".client-required-version").html(client_min_version),$(".client-your-version").html(b.version),$("#client-version-modal").modal("show")):client_version<version_as_number(client_recommended_version)&&($(".bpc-version").addClass("hidden"),$("#client-warning-span").removeClass("hidden"),$(".client-required-version").html(client_recommended_version),$(".client-your-version").html(b.version),
$("#client-version-modal").modal("show")):($(".bpc-version").addClass("hidden"),$("#client-unknown-span").removeClass("hidden"),$(".client-required-version").html(client_min_version),$(".client-your-version").html(b.version||"<b>UNKNOWN</b>"),$("#client-version-modal").modal("show")),client_use_type="http",client_available=!0,set_ui_buttons("available"),check_com_ports&&"function"===typeof check_com_ports&&(check_com_ports(),check_com_ports_interval=setInterval(check_com_ports,5E3)));setTimeout(check_client,
2E4)}).fail(function(){clearInterval(check_com_ports_interval);client_use_type="none";ports_available=client_available=!1;set_ui_buttons("unavailable");check_ws_socket_timeout=setTimeout(find_client,3E3)})},connection_heartbeat=function(){if("ws"===client_use_type){var b=(new Date).getTime();client_ws_heartbeat+12E3<b&&(client_ws_connection.close(),lostWSConnection())}},configure_client=function(){var b=$("<form/>",{class:"form-inline"});$("<span/>",{class:"space_right"}).text("http://").appendTo(b);
var c=$("<div/>",{class:"form-group"}).appendTo(b);$("<input/>",{id:"domain_name",type:"text",class:"form-control",value:client_domain_name}).appendTo(c);$("<span/>",{class:"space_left space_right"}).text(":").appendTo(b);c=$("<div/>",{class:"form-group"}).appendTo(b);$("<input/>",{id:"port_number",type:"number",class:"form-control",value:client_domain_port}).appendTo(c);bootbox.dialog({title:"Configure BlocklyPropClient",message:b,buttons:{cancel:{label:"Cancel",className:"btn-default"},save:{label:"Save",
className:"btn-success",callback:function(){client_domain_name=$("#domain_name").val();client_domain_port=$("#port_number").val();client_url="http://"+client_domain_name+":"+client_domain_port+"/"}}}})};
function establish_socket(){if(!client_available){set_port_list();var b=client_url.replace("http","ws"),c=new WebSocket(b);c.onopen=function(){null!==client_ws_connection&&client_ws_connection.close();var a={type:"hello-browser",baud:baudrate};client_ws_connection=c;c.send(JSON.stringify(a))};c.onerror=function(a){console.log("WebSocket Error");console.log(a)};c.onmessage=function(a){a=JSON.parse(a.data);if("hello-client"===a.type)client_version=version_as_number(a.version),console.log("Websocket client/launcher found - version "+
a.version),client_use_type="ws",client_available=!0,set_ui_buttons("available"),a=JSON.stringify({type:"port-list-request",msg:"port-list-request"}),c.send(a);else if("port-list"===a.type)client_ws_heartbeat=(new Date).getTime(),client_ws_heartbeat_interval||(client_ws_heartbeat_interval=setInterval(connection_heartbeat,4E3)),set_port_list(a.ports);else if("serial-terminal"===a.type&&("string"===typeof a.msg||a.msg instanceof String)){var b=atob(a.msg);void 0!==a.msg&&(null!==term?(displayInTerm(b),
$("#serial_console").focus()):null!==graph&&graph_new_data(b))}else"ui-command"===a.type?"open-terminal"===a.action?serial_console():"open-graph"===a.action?graphing_console():"close-terminal"===a.action?($("#console-dialog").modal("hide"),newTerminal=!1,updateTermBox(0)):"close-graph"===a.action?($("#graphing-dialog").modal("hide"),graph_reset()):"clear-compile"===a.action?$("#compile-console").val(""):"message-compile"===a.action?(client_version>=minCodedVer?(a=a.msg.split("-"),a[0]==nsDownloading&&
launcher_download||(launcher_result=launcher_result+a[1]+"\n",launcher_download|=a[0]==nsDownloading),a[0]==nsDownloadSuccessful?$("#compile-console").val($("#compile-console").val()+" Succeeded."):a[0]==neDownloadFailed?$("#compile-console").val($("#compile-console").val()+" Failed!\n\n-------- loader messages --------\n"+launcher_result):$("#compile-console").val($("#compile-console").val()+".")):$("#compile-console").val($("#compile-console").val()+a.msg),a=document.getElementById("compile-console"),
a.scrollTop=a.scrollHeight):"close-compile"===a.action?($("#compile-dialog").modal("hide"),$("#compile-console").val("")):"console-log"===a.action?console.log(a.msg):"websocket-close"===a.action?client_ws_connection.close():"alert"===a.action&&alert(a.msg):console.log("Unknown WS msg: "+JSON.stringify(a))};c.onClose=function(){lostWSConnection()}}}
function lostWSConnection(){client_ws_connection=null;client_use_type="none";ports_available=client_available=!1;set_ui_buttons("unavailable");term=null;newTerminal=!1;set_port_list();client_ws_heartbeat_interval&&(clearInterval(client_ws_heartbeat_interval),client_ws_heartbeat_interval=null);check_ws_socket_timeout=setTimeout(find_client,3E3)}
var set_port_list=function(b){b=b?b:"searching";var c=$("#comPort").val();$("#comPort").empty();"object"===typeof b&&b.length?(b.forEach(function(a){$("#comPort").append($("<option>",{text:a}))}),ports_available=!0):($("#comPort").append($("<option>",{text:"searching"===b?"Searching...":"No devices found"})),ports_available=!1);select_com_port(c)};
